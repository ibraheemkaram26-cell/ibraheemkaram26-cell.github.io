<!DOCTYPE html>
<html lang="ar">

<head>
  <meta charset="utf-8" />
  <title>Ramallah Waste Containers</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <style>
    body {
      margin: 0;
      height: 100%;
      width: 100%;
      background-color: #0f0f0f;
      font-family: "Segoe UI", Arial, sans-serif;
      color: #fff;
    }

    #map {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      bottom: 0;
    }

    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ„ØªØ±Ø© */
    #filterContainer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.97);
      padding: 10px 14px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
      font-size: 14px;
      z-index: 1000;
      transition: all 0.3s ease;
      color: #222;
    }

    #filterContainer:hover {
      transform: scale(1.03);
    }

    #filterContainer select {
      padding: 5px 6px;
      border-radius: 6px;
      border: 1px solid #999;
      margin-left: 6px;
      cursor: pointer;
    }

    /* Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª */
    #counter {
      position: absolute;
      bottom: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 1000;
      line-height: 1.6;
    }

    /* Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ */
    .leaflet-control-locate {
      background: white;
      padding: 6px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 18px;
      text-align: center;
      line-height: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* Popup ØªØµÙ…ÙŠÙ… Ø­Ø¯ÙŠØ« */
    .leaflet-popup-content {
      font-size: 14px;
      line-height: 1.5;
    }

    .popup-title {
      color: #ff9800;
      font-weight: bold;
      font-size: 15px;
    }

    /* Ø²Ø± Ø£Ù‚Ø±Ø¨ Ø­Ø§ÙˆÙŠØ© */
    .find-nearest-btn {
      position: absolute;
      top: 70px;
      right: 10px;
      background: #2ecc71;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
      transition: background 0.3s;
      z-index: 1000;
    }

    .find-nearest-btn:hover {
      background: #27ae60;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙ„ØªØ±Ø© -->
  <div id="filterContainer">
    <label><b>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©:</b></label>
    <select id="typeFilter">
      <option value="all">Ø§Ù„ÙƒÙ„</option>
      <option value="Plastic">Ø¨Ù„Ø§Ø³ØªÙŠÙƒ</option>
      <option value="Organic">Ø¹Ø¶ÙˆÙŠ</option>
      <option value="Glass">Ø²Ø¬Ø§Ø¬</option>
      <option value="Paper">ÙˆØ±Ù‚</option>
      <option value="Mixed">Ù…Ø®ØªÙ„Ø·</option>
    </select>
  </div>

  <!-- Ø²Ø± Ø£Ù‚Ø±Ø¨ Ø­Ø§ÙˆÙŠØ© -->
  <button class="find-nearest-btn" id="findNearest">ğŸ” Ø£Ù‚Ø±Ø¨ Ø­Ø§ÙˆÙŠØ©</button>

  <!-- Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª -->
  <div id="counter">
    Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: 0<br>
    <span id="typeBreakdown"></span>
  </div>

  <!-- JS Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    // ğŸ—ºï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    const map = L.map("map", {
      center: [31.9045, 35.2045],
      zoom: 17,
      zoomSnap: 0.5
    });

    // ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø¯Ø§ÙƒÙ†Ø© + ÙØ§ØªØ­Ø© + Ù‚Ù…Ø± ØµÙ†Ø§Ø¹ÙŠ
    const darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap | CARTO',
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(map);

    const lightMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap | CARTO',
      subdomains: 'abcd',
      maxZoom: 20
    });

    const satelliteMap = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      maxZoom: 20,
      subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
      attribution: '&copy; Google'
    });

    let zonesLayer;
    let wasteContainersLayer = L.layerGroup().addTo(map);
    let allContainers = [];

    // ğŸŸ¡ ØªØ­Ù…ÙŠÙ„ Ù…Ù†Ø§Ø·Ù‚ Ø±Ø§Ù… Ø§Ù„Ù„Ù‡
    $.getJSON("RamallahZones.json", function (RZ) {
      zonesLayer = L.geoJson(RZ, {
        style: { fillColor: "yellow", fillOpacity: 0.25, color: "yellow", weight: 1 },
        onEachFeature: (feature, layer) => {
          layer.bindPopup(`<div class='popup-title'>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</div>${feature.properties.NAME}`);
        }
      }).addTo(map);
    });

    // ğŸŸ  ØªØ­Ù…ÙŠÙ„ Ø·Ø¨Ù‚Ø© Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
    $.getJSON("wasteContainer.json", function (WC) {
      WC.features.forEach(feature => {
        const latlng = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
        const color = getColorByType(feature.properties.TYPE_OF_WA);

        const icon = L.divIcon({
          className: "custom-icon",
          html: `<div style="background:${color}; width:14px; height:14px; border-radius:50%; border:2px solid white;"></div>`,
          iconSize: [14, 14]
        });

        const marker = L.marker(latlng, { icon });
        marker.bindPopup(`
          <div class="popup-title">â™»ï¸ Ù†ÙˆØ¹ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª:</div> ${feature.properties.TYPE_OF_WA}<br>
          <div><b>ğŸ“ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</b><br>${latlng[0].toFixed(5)}, ${latlng[1].toFixed(5)}</div>
        `);

        marker.on("mouseover", () => marker._icon.style.transform = "scale(1.5)");
        marker.on("mouseout", () => marker._icon.style.transform = "scale(1)");

        wasteContainersLayer.addLayer(marker);
        allContainers.push({ marker, type: feature.properties.TYPE_OF_WA, latlng });
      });

      updateCounter(allContainers);
    });

    // ğŸ¨ Ø£Ù„ÙˆØ§Ù† Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    function getColorByType(type) {
      switch (type) {
        case "Plastic": return "#f5b700";
        case "Organic": return "#2ecc71";
        case "Glass": return "#3498db";
        case "Paper": return "#d2691e";
        case "Mixed": return "#bdc3c7";
        default: return "orange";
      }
    }

    // ğŸ” ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    document.getElementById("typeFilter").addEventListener("change", function () {
      const selectedType = this.value;
      wasteContainersLayer.clearLayers();

      const filtered = allContainers.filter(item =>
        selectedType === "all" || item.type === selectedType
      );

      filtered.forEach(item => wasteContainersLayer.addLayer(item.marker));
      updateCounter(filtered);
    });

    // ğŸ“Š Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª ÙˆØªØ­Ù„ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    function updateCounter(containers) {
      document.getElementById("counter").innerHTML = `
        Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${containers.length}<br>
        ${getTypeBreakdown(containers)}
      `;
    }

    function getTypeBreakdown(list) {
      const counts = {};
      list.forEach(i => counts[i.type] = (counts[i.type] || 0) + 1);
      return Object.entries(counts)
        .map(([t, c]) => `<span style="color:${getColorByType(t)}">â—</span> ${t}: ${c}`)
        .join(" | ");
    }

    // ğŸ§­ Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ
    const locateControl = L.control({ position: 'topleft' });
    locateControl.onAdd = function () {
      const div = L.DomUtil.create('div', 'leaflet-control-locate');
      div.innerHTML = "ğŸ“";
      div.title = "ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ";
      div.onclick = function () {
        map.locate({ setView: true, maxZoom: 18 });
      };
      return div;
    };
    locateControl.addTo(map);

    map.on('locationfound', e => {
      L.circleMarker(e.latlng, {
        radius: 6,
        fillColor: 'aqua',
        color: '#00ffff',
        weight: 2,
        fillOpacity: 0.9
      }).addTo(map).bindPopup("ğŸ“ Ø£Ù†Øª Ù‡Ù†Ø§").openPopup();
      userLocation = e.latlng;
    });

    // ğŸ” Ø²Ø± Ø£Ù‚Ø±Ø¨ Ø­Ø§ÙˆÙŠØ©
    let userLocation = null;
    document.getElementById("findNearest").addEventListener("click", () => {
      if (!userLocation) {
        alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø£ÙˆÙ„Ø§Ù‹ ğŸ“");
        map.locate({ setView: true, maxZoom: 18 });
        return;
      }

      let nearest = null;
      let minDist = Infinity;

      allContainers.forEach(c => {
        const dist = map.distance(userLocation, c.latlng);
        if (dist < minDist) {
          minDist = dist;
          nearest = c;
        }
      });

      if (nearest) {
        L.polyline([userLocation, nearest.latlng], { color: "lime", weight: 3, dashArray: "5,8" })
          .addTo(map)
          .bindPopup(`Ø£Ù‚Ø±Ø¨ Ø­Ø§ÙˆÙŠØ© (${nearest.type}) ØªØ¨Ø¹Ø¯ ${(minDist).toFixed(1)} Ù…ØªØ±`).openPopup();

        map.setView(nearest.latlng, 18);
      }
    });

    // âš™ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    L.control.scale({ position: 'bottomleft', imperial: false }).addTo(map);
    L.Control.geocoder({ position: 'topleft' }).addTo(map);

    L.control.layers(
      { "Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¯Ø§ÙƒÙ†Ø©": darkMap, "Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ÙØ§ØªØ­Ø©": lightMap, "Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ": satelliteMap },
      { "Ø§Ù„Ù…Ù†Ø§Ø·Ù‚": zonesLayer, "Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª": wasteContainersLayer }
    ).addTo(map);
  </script>
</body>

</html>

